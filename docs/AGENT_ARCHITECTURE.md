# OpenCode 智能体架构与扩展开发指南

本文档旨在为开发者提供关于 OpenCode 智能体（Agent）系统的深度解析，以及如何通过插件机制（如 `oh-my-opencode`）进行二次开发和扩展的实战指南。

## 1. 核心架构机制 (The Native Core)

OpenCode 的智能体列表并非静态硬编码在 UI 中，而是通过动态配置加载机制生成的。

### 1.1 源码位置
核心逻辑位于 `packages/opencode/src/agent/agent.ts`。

### 1.2 加载流程
1.  **Config.get()**: 系统启动时，调用此方法读取全局配置。
2.  **Agent.list()**: 调用 `Config.get()` 获取当前的 Agent 配置列表。
3.  **State Initialization**: 初始化 `state`，其中包括了两个“原生”硬编码的 Agent：
    *   `plan` (规划模式)
    *   `build` (执行模式)
4.  **Merging**: 将配置文件中的自定义 Agent 与原生 Agent 合并。

### 1.3 数据结构 (Agent.Info)
每个智能体由 `Zod` Schema 定义，关键字段包括：
*   `name`: 唯一标识符 (ID)
*   `description`: 显示在 UI 下拉列表中的描述文本
*   `mode`: `primary` (主智能体), `subagent` (子智能体), 或 `all`
*   `model`: 绑定的 LLM 模型 (ProviderID + ModelID)
*   `prompt`: 系统提示词 (System Prompt)
*   `permission`: 权限集合 (允许读写哪些文件、执行哪些工具)

---

## 2. 插件注入机制 (The Plugin Magic)

以 `oh-my-opencode` 为例，外部插件是如何在不修改源码的情况下注入新智能体的？

### 2.1 原理：配置注入 (Configuration Injection)
插件并不直接修改 `agent.ts` 源码，而是利用 OpenCode 的插件系统接口进行“配置拦截”或“状态合并”。

*   **Hook 机制**: 插件注册特定的 Hook (如 `claude-code-agent-loader`)。
*   **拦截点**: 当 OpenCode 初始化配置时，插件 Hook 被触发。
*   **注入逻辑**: 插件读取自己的配置文件（如 `oh-my-opencode.json`），将其中的 `agents` 数组注入到 OpenCode 的运行时配置对象中。

### 2.2 结果
OpenCode 主程序无法区分哪些是原生配置，哪些是插件注入的。它看到的是一个合并后的完整列表，因此会在 UI (VSCode 侧边栏 @ 下拉菜单) 中渲染出所有的 Agent。

---

## 3. 实战：如何添加自定义智能体

想要为 OpenCode 增加新的智能体（如 "架构师"、"测试专家"），无需重新编译源码，只需修改配置文件。

### 3.1 配置文件位置
*   **Windows**: `C:\Users\{Username}\.config\opencode\oh-my-opencode.json`
*   **macOS/Linux**: `~/.config/opencode/oh-my-opencode.json`

### 3.2 配置格式
在 `agents` 字段下添加新的 JSON 对象：

```json
{
  "agents": {
    "my-custom-agent": {
      "enabled": true,
      "model": "AntigravityToolsGemini/gemini-3-pro-high",
      "description": "我的自定义智能体 (中文备注) - 专用于xxx任务",
      "prompt": "You are a specialized agent for...",
      "temperature": 0.5
    }
  }
}
```

### 3.3 关键字段说明
*   **key ("my-custom-agent")**: 调用时的 ID (如 `@my-custom-agent`)。
*   **model**: 必须匹配 `provider` 中已注册的模型 ID。
*   **description**: **支持中文**。这里的内容会直接显示在 UI 的下拉列表中。
    *   *Tip*: 推荐格式 `Name (角色) - 功能描述`，例如 `Metis (谋士) - 需求分析`。

---

## 4. 高级开发：创建新插件

如果您想开发类似 `oh-my-opencode` 的插件来分发一套智能体：

1.  **项目结构**:
    ```
    my-plugin/
    ├── package.json
    ├── src/
    │   ├── index.ts       # 插件入口
    │   └── agents.ts      # 智能体定义
    ```

2.  **注册 Hook**:
    在 `index.ts` 中导出一个函数，接收 `PluginContext`。
    使用 `ctx.config.merge()` 或类似的 API (取决于 OpenCode Plugin SDK 版本) 来合并您的 Agent 配置。

3.  **分发**:
    用户安装插件后，您的智能体将自动出现在他们的列表中。

---

## 5. 常见问题排查

*   **Q: 添加了配置但 UI 没变化？**
    *   A: 配置文件在启动时加载。请完全重启 OpenCode (或 VSCode 窗口)。

*   **Q: 报错 "requires a default model"？**
    *   A: 检查 `oh-my-opencode.json` 中是否缺少 `categories` 映射。插件的高级功能 (delegate_task) 依赖分类到模型的映射。

*   **Q: 中文描述乱码？**
    *   A: 确保 JSON 文件保存为 UTF-8 编码。

---

*文档生成时间: 2026-01-25*
*Generated by: Sisyphus (OpenCode Ultrawork)*
